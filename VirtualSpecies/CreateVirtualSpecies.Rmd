---
title: "MasterVS_1"
author: "Kristian Suszczenia"
date: "2024-11-09"
output: html_document
---

In this code we start with the creation of virtual species, and use these to genorate resistance rasters and population presence points; the inputs for connectivity analysis. 
As in the rest of the repository, #explanations will only be shown in first instance of codes use

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Install the packages, and library. Library the other dependencies.
```{r isntall packages}
#use isntall.packages() if needed
library(virtualspecies)
library(ade4)
library(dismo)
library(rworldmap)
library(terra)
library(raster)
library(dplyr)
library(here)
library(spatialEco)
```


## 1) Load Input Layers

```{r Load input layers}
#Load enviornemntal layers as SpatRaster
Elevation <- rast(here('VirtualSpecies', 'inputData_forVS', 'CurrentEnvData', 'Elev_nibbled_jenk.tif'))
MeanTemp <- rast(here('VirtualSpecies', 'inputData_forVS', 'CurrentEnvData', 'BIO1_30s_now.tif'))
AnnualPrec <- rast(here('VirtualSpecies', 'inputData_forVS', 'CurrentEnvData', 'BIO12_30s_now.tif'))

#Make our objects into a *string of layers*, and set more useful names
EnvLayers <- c(Elevation, MeanTemp, AnnualPrec)
names(EnvLayers) <- paste0(c("Elevation", "MeanTemp", "AnnualPrec"))
EnvLayers
```

We can see that they are the correct format (SpatRaster), sharing the same extent and resolution, and CRS.

## 2) Initial Suitability functions

For reference. We plan to create 6 species, 2 sets of 3. In each set there will be a Generalist, Wet Specialist, and Dry specialist. There will be a set for High and Low Elevation (so 6 in total).

# The parameters are as follows:

Elevation (range)

Highland = 479 to 3966
Lowland  = -36 to 478

Temperature (mean)

Highland mean = 23.07 (range; 8-28 sd; 1.573)
Lowland mean  = 26.73 (range; 22-29, sd; 0.741)

Precipitation (mean)

Highland dry = 2601.74 (range; 1630-3144, sd; 347.097) *HD*
Highland wet = 3687.75 (range; 3145-4252, sd; 282.767) *HW*
Highland Gen = 3341.10 (range; 1637-4252, sd; 590.927) *HG*

Lowland dry  = 2496.18 (range; 1572-2957, sd; 314.665) *LD*
Lowland wet  = 3420.59 (range; 2958-4310, sd; 331.150) *LW*
Lowland Gen  = 2955.42 (range; 1572-4310, sd; 563.852) *LG*

# Example: Highland DRY Specialist

prefers temperatures of 23.07* (dnorm), precipitation around 2601.74 l/yr (dnorm), and elevations above 479m from sea level (sigmoidal relationship is most appropriate). 

```{r example VS genoration}
#Set the env-suitability relationship functions, the collection of functions is the Initial suitability function (ISF)
ISF_HD <- formatFunctions(MeanTemp = c(fun = 'dnorm', mean = 23.07, sd = 1.573),
                          AnnualPrec = c(fun = 'dnorm', mean = 2601.74, sd = 347.097),
                          Elevation = c(fun = 'logisticFun', beta = 479, alpha = -70))

#These are then combined via a method (default is multiplicative) to create a scale of Habitat suitability scaling 0-1. The combination of functions is the Habitat suitability Index (HSI)
HSI_HD <- generateSpFromFun(raster.stack = EnvLayers[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_HD, 
                                      plot = TRUE)

#Plot to see how each function is operating in the HSI
plotResponse(HSI_HD)
```

Now we can convert this to a probability occurrence (which we will do linearly, so 0.6 means a 60% probability of occurrence). This is much better than the threshold method.

We should use a consistant way to set prevelence; such as 5% of the total land area pixels. This means each VS should end up with the same number of presences (or similar due to R setting the funciton to try and get as close to 5% as possible given the restrictions).

We also need to use a consistant alpha value for the logistic transformation, so that the shape of the probabiltiy of occurence is the same for each VS; meaning the only thing that changes is their preferences.

### Used VS:

#Highland DRY Specialist
this is the same process, with the addition that we convert the probability occurence raster to presence/asbence

```{r Set HD VS, and collect PA}
#Set the env-suitability relationship functions, the collection of functions is the Initial suitability function (ISF)
ISF_HD <- formatFunctions(MeanTemp = c(fun = 'dnorm', mean = 23.07, sd = 1.573),
                          AnnualPrec = c(fun = 'dnorm', mean = 2601.74, sd = 347.097),
                          Elevation = c(fun = 'logisticFun', beta = 479, alpha = -70))

#These are then combined via a method (default is multiplicative) to create a scale of Habitat suitability scaling 0-1. The combination of functions is the Habitat suitability Index (HSI)
HSI_HD <- generateSpFromFun(raster.stack = EnvLayers[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_HD, 
                                      plot = TRUE)

#Plot to see how each function is operating in the HSI
plotResponse(HSI_HD)

#Convert tor presence points
Presence_HD <- convertToPA(HSI_HD, 
                   PA.method = "probability", #here you choose threshold or probability method
                   prob.method = "linear", a = 1, b = 0, 
                   plot = FALSE) 

plotSuitabilityToProba(Presence_HD)
plot(Presence_HD$pa.raster)
```

we can repeat this with all species

#Highland WET Specialist
```{r Set HW VS, and collect PA}
#Set the env-suitability relationship functions, the collection of functions is the Initial suitability function (ISF)
ISF_HW <- formatFunctions(MeanTemp = c(fun = 'dnorm', mean = 23.07, sd = 1.573),
                          AnnualPrec = c(fun = 'dnorm', mean = 3687.75, sd = 282.767),
                          Elevation = c(fun = 'logisticFun', beta = 479, alpha = -70))

#These are then combined via a method (default is multiplicative) to create a scale of Habitat suitability scaling 0-1. The combination of functions is the Habitat suitability Index (HSI)
HSI_HW <- generateSpFromFun(raster.stack = EnvLayers[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_HW, 
                                      plot = TRUE)

#Plot to see how each function is operating in the HSI
plotResponse(HSI_HW)

Presence_HW <- convertToPA(HSI_HW, 
                   PA.method = "probability", 
                   prob.method = "linear", a = 1, b = 0, 
                   plot = FALSE) 

#view
plotSuitabilityToProba(Presence_HW)
plot(Presence_HW$pa.raster)
```

### High Elevation Generalist
```{r Set HG VS, and collect PA}
#Set the env-suitability relationship functions, the collection of functions is the Initial suitability function (ISF)
ISF_HG <- formatFunctions(MeanTemp = c(fun = 'dnorm', mean = 23.07, sd = 1.573),
                          AnnualPrec = c(fun = 'dnorm', mean = 3341.1, sd = 590.927),
                          Elevation = c(fun = 'logisticFun', beta = 479, alpha = -70))

#These are then combined via a method (default is multiplicative) to create a scale of Habitat suitability scaling 0-1. The combination of functions is the Habitat suitability Index (HSI)
HSI_HG <- generateSpFromFun(raster.stack = EnvLayers[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_HG, 
                                      plot = TRUE)

#Plot to see how each function is operating in the HSI
plotResponse(HSI_HG)

#Convert to presence points
Presence_HG <- convertToPA(HSI_HG, 
                   PA.method = "probability", 
                   prob.method = "linear", a = 1, b = 0, 
                   plot = FALSE) 

plotSuitabilityToProba(Presence_HG)
plot(Presence_HG$pa.raster)
```

### Low Elevation DRY specialist
```{r Set LD VS, and collect PA}
#Set the env-suitability relationship functions, the collection of functions is the Initial suitability function (ISF)
ISF_LD <- formatFunctions(MeanTemp = c(fun = 'dnorm', mean = 26.73, sd = 0.741),
                          AnnualPrec = c(fun = 'dnorm', mean = 2496.18, sd = 314.665),
                          Elevation = c(fun = 'logisticFun', beta = 479, alpha = 70))

#These are then combined via a method (default is multiplicative) to create a scale of Habitat suitability scaling 0-1. The combination of functions is the Habitat suitability Index (HSI)
HSI_LD <- generateSpFromFun(raster.stack = EnvLayers[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_LD, 
                                      plot = TRUE)

#Plot to see how each function is operating in the HSI
plotResponse(HSI_LD)

#Convert to presence points
#Or logistic?
Presence_LD <- convertToPA(HSI_LD, 
                   PA.method = "probability", 
                   prob.method = "logistic", alpha = -0.08, 
                   species.prevalence = 0.1,
                   plot = FALSE) 

plotSuitabilityToProba(Presence_LD)
plot(Presence_LD$pa.raster)
```

### Low Elevation WET specialist
```{r Set LW VS, and collect PA}
#Set the env-suitability relationship functions, the collection of functions is the Initial suitability function (ISF)
ISF_LW <- formatFunctions(MeanTemp = c(fun = 'dnorm', mean = 26.73, sd = 0.741),
                          AnnualPrec = c(fun = 'dnorm', mean = 3420.59, sd = 331.15),
                          Elevation = c(fun = 'logisticFun', beta = 479, alpha = 70))

#These are then combined via a method (default is multiplicative) to create a scale of Habitat suitability scaling 0-1. The combination of functions is the Habitat suitability Index (HSI)
HSI_LW <- generateSpFromFun(raster.stack = EnvLayers[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_LW, 
                                      plot = TRUE)

#Plot to see how each function is operating in the HSI
plotResponse(HSI_LW)

#Convert to presence points
#or logistic
Presence_LW <- convertToPA(HSI_LW, 
                   PA.method = "probability", 
                   prob.method = "logistic", alpha = -0.08, 
                   species.prevalence = 0.1,
                   plot = FALSE) 

plotSuitabilityToProba(Presence_LW)
plot(Presence_LW$pa.raster)
```


## Low Elevation Generalist
```{r Set LG VS, and collect PA}
#Set the env-suitability relationship functions, the collection of functions is the Initial suitability function (ISF)
ISF_LG <- formatFunctions(MeanTemp = c(fun = 'dnorm', mean = 26.73, sd = 0.741),
                          AnnualPrec = c(fun = 'dnorm', mean = 2955.42, sd = 563.852),
                          Elevation = c(fun = 'logisticFun', beta = 479, alpha = 70))

#These are then combined via a method (default is multiplicative) to create a scale of Habitat suitability scaling 0-1. The combination of functions is the Habitat suitability Index (HSI)
HSI_LG <- generateSpFromFun(raster.stack = EnvLayers[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_LG, 
                                      plot = TRUE)

#Plot to see how each function is operating in the HSI
plotResponse(HSI_LG)

#Convert to presence points
#Or logsitic?
Presence_LG <- convertToPA(HSI_LG, 
                   PA.method = "probability", 
                   prob.method = "logistic", alpha = -0.08, 
                   species.prevalence = 0.1,
                   plot = FALSE) 

plotSuitabilityToProba(Presence_LG)
plot(Presence_LG$pa.raster)
```

###############################################################################

### Save the habitat suitability and population area for Export to ARCGIS

This is just to showcase the process. The True Habitat suitability is transformed into a smaller population distribution liklihood (which puts them in the most suitable places, with comparable populations sizes), and these pixel probabilities are used to radnomly draw a Presence Absence True Population. 
```{r view the three raster outputs}
#view
plot(Presence_LW$suitab.raster)
plot(Presence_LW$probability.of.occurrence)
plot(Presence_LW$pa.raster)
```
We will save the VS ('Presence_X') as this contains the habitat suitability raster and the true presence/absence. 
We will also save the suitability raster itself, separately, and the true presence absence, as TIFs.
Then we will save the sampled presence points as a csv.

```{r save the habitat suitability and PA rasters}
#use your own saving structure
#HD
save(Presence_HD, file = "")

writeRaster(Presence_HD$suitab.raster, "")
writeRaster(Presence_HD$pa.raster, "")

#HW
save(Presence_HW, file = "")

writeRaster(Presence_HW$suitab.raster, "")
writeRaster(Presence_HW$pa.raster, "")

#HG

save(Presence_HG, file = "")

writeRaster(Presence_HG$suitab.raster, '')
writeRaster(Presence_HG$pa.raster, '')

#LD
save(Presence_LD, file = "")

writeRaster(Presence_LD$suitab.raster, '')
writeRaster(Presence_LD$pa.raster, '')

#LW
save(Presence_LW, file = "")

writeRaster(Presence_LW$suitab.raster,'')
writeRaster(Presence_LW$pa.raster, '')

#LG
save(Presence_LG, file = "")

writeRaster(Presence_LG$suitab.raster, "")
writeRaster(Presence_LG$pa.raster, '')

```

################################################################################

### Sampling Presence/Absence

Now we want to create the start/end points (population sites) used in the connecitivty graphing. If we were to set this at, say, 1000 points, the species with smaller range would be more concentrated. Instead, I specify no sample size of presences and just sample 6,000 points (pesence or absence) randomly. This will cause our detected occurences to reflect the size of the population beneath.

as such;
```{r sample detected occurence points, HD}
#sample occurence withotu specifying a ratio of Presence to Absence
SampledOcc_HD <- sampleOccurrences(HD_perfectDIST, 
                                        n = 6000, 
                                        type = "presence-absence")
```

And save these coordinates (as P_HD2.csv) so we can look at them:
```{r save PA points}
#save the presence and absence points
write.csv(SampledOcc_HD$sample.points, "")
```

#Clean the PA points for connectivity analysis 

Now we can load and interrogate them. Here I take a few steps to format these points for input into CoLa.

```{r Load and Format PA points}
#Load the coords
HD_coords2 <- read.csv(here('VirtualSpecies', 'inputData_forVS', 'PApoints', 'P_HD2.csv'), header = TRUE, stringsAsFactors = FALSE)

#R has read the ID column as 'X' so we can clean that out
HD_coords2 <- subset(HD_coords2, select = -X )

#Extract() expects coord only, so we will make that
HD_coords2_only <- subset(HD_coords2, select = c(x, y))

#And lets get the presence points alone
HD_presenceonly2 <- HD_coords2[HD_coords2$Observed == 1, ]

```

Plot ontop of the HSI:
```{r plot PA points on habitat suitability}
# load the perfect HSI raster
HD_perfectHSI <- rast(here('VirtualSpecies', 'inputData_forVS', 'HabitatSuitability', 'Suitability_HD1.tif'))

#Plot the true HSI
plot(HD_perfectHSI, main = 'True HSI') +
  points(HD_presenceonly2, col = 'red', pch = 4, cex = 0.05)
```

Plot ontop of the true dist
```{r Plot PA points over the true population}
#also load the perfect HSI raster
HD_perfectDIST <- rast(here('VirtualSpecies', 'inputData_forVS', 'PopulationDist', 'RealDist_HD1.tif'))

#Plot the true dist
plot(HD_perfectDIST, main = 'True HSI') +
  points(HD_presenceonly2, col = 'red', pch = 4, cex = 0.05)
```

We can see that the presence points (red) are much less dense (underdispersed), but we should count them to see if this is a workable dataset to habitat suitability model with.

```{r Count detected occurences}
nrow(HD_coords2) #6,000
nrow(HD_presenceonly2) #183
```

Now, we need to save the presence only dataset as a .XY file for input into connectivity software (this is the needed input)
```{r Create PXY file}
# make a dataset that is only the XY coordinates of presence
HD_PXY <- subset(HD_presenceonly2, select = c(x, y))

#And save as CSV
write.csv(HD_PXY, 
          "/PXY_HD.csv")
```

One assumption CoLa needs is that the coords fit within the raster extent
```{r retrieve extent}
# Get the raster's extent
HD_resistance_ext <- extent(HD_resistanceASC)
```

We can see here that they do:
```{r check that P points lie within extent}
#check the coord extent
min_x <- min(HD_PXY$x)
max_x <- max(HD_PXY$x)
min_y <- min(HD_PXY$y)
max_y <- max(HD_PXY$y) # == they do lie within the extent...
HD_coord_ext <- data.frame(min_x, max_x, min_y, max_y)
HD_coord_ext

#ensure there are no NAs
any(is.na(HD_PXY))
anyNA(HD_resistanceASC)
```


This is the smallest population distribution so, theoretically, will get the smallest sample. But a sample of 167 is not bad.

Lastly, connectivity software often request for the resistance raster in ASCII format. The resistance raster can be made quite simply by loading the habitat suitability into arcgis and using raster calculator to invert, following any inversion method of your choosing. 

This inversion can be done in R as so:
```{r Create the Resistance Raster}
#Load the HD HSI raster
HD_perfectHSI <- rast(here('VirtualSpecies', 'inputData_forVS', 'HabitatSuitability', 'Suitability_HD1.tif'))

HD_invert <- raster.invert(HD_perfectHSI)
HD_resi <- raster.transformation(HD_invert, trans = "stretch", smin=1, smax= 99)

# Check for NAs using anyNA
any_na <- anyNA(values(HD_resi))
if (any_na) {
  print("There are NA values in the raster")
} else {
  print("There are no NA values in the raster")
}

#view
plot(HD_resi)
```

You will still have to use raster to ASCII in arcgis. I have saved my ascii files within the github repository for use if needed.

# This process must be repeated to genorate the PXY and Resistance.asci for all species

here I include code with less explanation

## 2) HG

```{r HG PXY and Resistance.asci}
#Load the popualtion distribution of HG
HG_perfectDIST <- rast(here('VirtualSpecies', 'inputData_forVS', 'PopulationDist', 'RealDist_HG1.tif'))

#create new better sample
SampledOcc_HG <- sampleOccurrences(HG_perfectDIST, 
                                        n = 6000, 
                                        type = "presence-absence")

#Load the coords
HG_coords2 <- read.csv(here('VirtualSpecies', 'inputData_forVS', 'PApoints', 'P_HG2.csv'), header = TRUE, stringsAsFactors = FALSE)

#R has read the ID column as 'X' so we can clean that out
HG_coords2 <- subset(HG_coords2, select = -X )

#Extract() expects coord only, so we will make that
HG_coords2_only <- subset(HG_coords2, select = c(x, y))

#And lets get the presence points alone
HG_presenceonly2 <- HG_coords2[HG_coords2$Observed == 1, ]

#also load the perfect HSI raster
HG_perfectHSI <- rast(here('VirtualSpecies', 'inputData_forVS', 'HabitatSuitability', 'Suitability_HG1.tif'))

#Plot the true HSI
plot(HG_perfectHSI, main = 'True HSI') +
  points(HG_presenceonly2, col = 'red', pch = 4, cex = 0.05)

#And calculate the sample size
nrow(HG_coords2) #6,000
nrow(HG_presenceonly2) #505

# make a dataset that is only the XY coordinates of presence
HG_PXY <- subset(HG_presenceonly2, select = c(x, y))

#Load the HG HSI raster
HG_perfectHSI <- rast(here('VirtualSpecies', 'inputData_forVS', 'HabitatSuitability', 'Suitability_HG1.tif'))

HG_invert <- raster.invert(HG_perfectHSI)
HG_resi <- raster.transformation(HG_invert, trans = "stretch", smin=1, smax= 99)

# Check for NAs using anyNA
any_na <- anyNA(values(HG_resi))
if (any_na) {
  print("There are NA values in the raster")
} else {
  print("There are no NA values in the raster")
}

plot(HG_resi)
```

## 3) HW

```{r HW PXY and Resistance.asci}
#Load the popualtion distribution of HW
HW_perfectDIST <- rast(here('VirtualSpecies', 'inputData_forVS', 'PopulationDist', 'RealDist_HW1.tif'))

#create new better sample
SampledOcc_HW <- sampleOccurrences(HW_perfectDIST, 
                                        n = 6000, 
                                        type = "presence-absence")

#Load the coords
HW_coords2 <- read.csv(here('VirtualSpecies', 'inputData_forVS', 'PApoints', 'P_HW2.csv'), header = TRUE, stringsAsFactors = FALSE)

#R has read the ID column as 'X' so we can clean that out
HW_coords2 <- subset(HW_coords2, select = -X )

#Extract() expects coord only, so we will make that
HW_coords2_only <- subset(HW_coords2, select = c(x, y))

#And lets get the presence points alone
HW_presenceonly2 <- HW_coords2[HW_coords2$Observed == 1, ]

#also load the perfect HSI raster
HW_perfectHSI <- rast(here('VirtualSpecies', 'inputData_forVS', 'HabitatSuitability', 'Suitability_HW1.tif'))

#Plot the true HSI
plot(HW_perfectHSI, main = 'True HSI') +
  points(HW_presenceonly2, col = 'red', pch = 4, cex = 0.05)

#And calculate the sample size
nrow(HW_coords2) #6,000
nrow(HW_presenceonly2) #505

# make a dataset that is only the XY coordinates of presence
HW_PXY <- subset(HW_presenceonly2, select = c(x, y))

#Load the HW HSI raster
HW_perfectHSI <- rast(here('VirtualSpecies', 'inputData_forVS', 'HabitatSuitability', 'Suitability_HW1.tif'))

HW_invert <- raster.invert(HW_perfectHSI)
HW_resi <- raster.transformation(HW_invert, trans = "stretch", smin=1, smax= 99)

# Check for NAs using anyNA
any_na <- anyNA(values(HW_resi))
if (any_na) {
  print("There are NA values in the raster")
} else {
  print("There are no NA values in the raster")
}

plot(HW_resi)
```


## 4) LD

```{r LD PXY and Resistance.asci}
#Load the popualtion distribution of LD
LD_perfectDIST <- rast(here('VirtualSpecies', 'inputData_forVS', 'PopulationDist', 'RealDist_LD1.tif'))

#create new better sample
SampledOcc_LD <- sampleOccurrences(LD_perfectDIST, 
                                        n = 6000, 
                                        type = "presence-absence")

#Load the coords
LD_coords2 <- read.csv(here('VirtualSpecies', 'inputData_forVS', 'PApoints', 'P_LD2.csv'), header = TRUE, stringsAsFactors = FALSE)

#R has read the ID column as 'X' so we can clean that out
LD_coords2 <- subset(LD_coords2, select = -X )

#Extract() expects coord only, so we will make that
LD_coords2_only <- subset(LD_coords2, select = c(x, y))

#And lets get the presence points alone
LD_presenceonly2 <- LD_coords2[LD_coords2$Observed == 1, ]

#also load the perfect HSI raster
LD_perfectHSI <- rast(here('VirtualSpecies', 'inputData_forVS', 'HabitatSuitability', 'Suitability_LD1.tif'))

#Plot the true HSI
plot(LD_perfectHSI, main = 'True HSI') +
  points(LD_presenceonly2, col = 'red', pch = 4, cex = 0.05)

#And calculate the sample size
nrow(LD_coords2) #6,000
nrow(LD_presenceonly2) #505

# make a dataset that is only the XY coordinates of presence
LD_PXY <- subset(LD_presenceonly2, select = c(x, y))

#Load the LD HSI raster
LD_perfectHSI <- rast(here('VirtualSpecies', 'inputData_forVS', 'HabitatSuitability', 'Suitability_LD1.tif'))

LD_invert <- raster.invert(LD_perfectHSI)
LD_resi <- raster.transformation(LD_invert, trans = "stretch", smin=1, smax= 99)

# Check for NAs using anyNA
any_na <- anyNA(values(LD_resi))
if (any_na) {
  print("There are NA values in the raster")
} else {
  print("There are no NA values in the raster")
}

plot(LD_resi)
```

## 5) LG

```{r LG PXY and Resistance.asci}
#Load the popualtion distribution of LG
LG_perfectDIST <- rast(here('VirtualSpecies', 'inputData_forVS', 'PopulationDist', 'RealDist_LG1.tif'))

#create new better sample
SampledOcc_LG <- sampleOccurrences(LG_perfectDIST, 
                                        n = 6000, 
                                        type = "presence-absence")

#Load the coords
LG_coords2 <- read.csv(here('VirtualSpecies', 'inputData_forVS', 'PApoints', 'P_LG2.csv'), header = TRUE, stringsAsFactors = FALSE)

#R has read the ID column as 'X' so we can clean that out
LG_coords2 <- subset(LG_coords2, select = -X )

#Extract() expects coord only, so we will make that
LG_coords2_only <- subset(LG_coords2, select = c(x, y))

#And lets get the presence points alone
LG_presenceonly2 <- LG_coords2[LG_coords2$Observed == 1, ]

#also load the perfect HSI raster
LG_perfectHSI <- rast(here('VirtualSpecies', 'inputData_forVS', 'HabitatSuitability', 'Suitability_LG1.tif'))

#Plot the true HSI
plot(LG_perfectHSI, main = 'True HSI') +
  points(LG_presenceonly2, col = 'red', pch = 4, cex = 0.05)

#And calculate the sample size
nrow(LG_coords2) #6,000
nrow(LG_presenceonly2) #505

# make a dataset that is only the XY coordinates of presence
LG_PXY <- subset(LG_presenceonly2, select = c(x, y))

#Load the LG HSI raster
LG_perfectHSI <- rast(here('VirtualSpecies', 'inputData_forVS', 'HabitatSuitability', 'Suitability_LG1.tif'))

LG_invert <- raster.invert(LG_perfectHSI)
LG_resi <- raster.transformation(LG_invert, trans = "stretch", smin=1, smax= 99)

# Check for NAs using anyNA
any_na <- anyNA(values(LG_resi))
if (any_na) {
  print("There are NA values in the raster")
} else {
  print("There are no NA values in the raster")
}

plot(LG_resi)
```

## 6) LW

```{r LW PXY and Resistance.asci}
#Load the popualtion distribution of LW
LW_perfectDIST <- rast(here('VirtualSpecies', 'inputData_forVS', 'PopulationDist', 'RealDist_LW1.tif'))

#create new better sample
SampledOcc_LW <- sampleOccurrences(LW_perfectDIST, 
                                        n = 6000, 
                                        type = "presence-absence")

#Load the coords
LW_coords2 <- read.csv(here('VirtualSpecies', 'inputData_forVS', 'PApoints', 'P_LW2.csv'), header = TRUE, stringsAsFactors = FALSE)

#R has read the ID column as 'X' so we can clean that out
LW_coords2 <- subset(LW_coords2, select = -X )

#Extract() expects coord only, so we will make that
LW_coords2_only <- subset(LW_coords2, select = c(x, y))

#And lets get the presence points alone
LW_presenceonly2 <- LW_coords2[LW_coords2$Observed == 1, ]

#also load the perfect HSI raster
LW_perfectHSI <- rast(here('VirtualSpecies', 'inputData_forVS', 'HabitatSuitability', 'Suitability_LW1.tif'))

#Plot the true HSI
plot(LW_perfectHSI, main = 'True HSI') +
  points(LW_presenceonly2, col = 'red', pch = 4, cex = 0.05)

#And calculate the sample size
nrow(LW_coords2) #6,000
nrow(LW_presenceonly2) #505

# make a dataset that is only the XY coordinates of presence
LW_PXY <- subset(LW_presenceonly2, select = c(x, y))

#Load the LW HSI raster
LW_perfectHSI <- rast(here('VirtualSpecies', 'inputData_forVS', 'HabitatSuitability', 'Suitability_LW1.tif'))

LW_invert <- raster.invert(LW_perfectHSI)
LW_resi <- raster.transformation(LW_invert, trans = "stretch", smin=1, smax= 99)

# Check for NAs using anyNA
any_na <- anyNA(values(LW_resi))
if (any_na) {
  print("There are NA values in the raster")
} else {
  print("There are no NA values in the raster")
}

plot(LW_resi)
```

Once you have taken these into ARCGIS to rpoduce resitance asciis, you have the inpit data for corridor netowrking for the *current* networks.

Yes that means we still have to repeat this entire process after applying the virtual species to a future scenario!

################################################################################

### Genorating inputs for future networks

First we need to load the future environmental data; the projected temperature and precipitaiton. Before loading these, you must ensure they have the same extent (in my case Borneo) and pixel dimensions in order for everything to work together. 

```{r Load projected scenario enviornmental data}
#repeat above loading process with projected scenario environmental data
#ssp126
MeanTemp_126_2021 <- rast(here('VirtualSpecies', 'inputData_forVS', 'FutureEnvData', 'Bio1_126_y21.tif'))
AnnualPrec_126_2021 <- rast(here('VirtualSpecies', 'inputData_forVS', 'FutureEnvData', 'Bio12_126_y21.tif'))
#then combine them into a single layer, with reasonable names
EnvLayers_126_2021 <- c(Elevation, MeanTemp_126_2021, AnnualPrec_126_2021)
names(EnvLayers_126_2021) <- paste0(c("Elevation", "MeanTemp", "AnnualPrec"))

#ssp245
MeanTemp_245_2021 <- rast(here('VirtualSpecies', 'inputData_forVS', 'FutureEnvData', 'Bio1_245_y21.tif'))
AnnualPrec_245_2021 <- rast(here('VirtualSpecies', 'inputData_forVS', 'FutureEnvData', 'Bio1_245_y21.tif'))
EnvLayers_245_2021 <- c(Elevation, MeanTemp_245_2021, AnnualPrec_245_2021)
names(EnvLayers_245_2021) <- paste0(c("Elevation", "MeanTemp", "AnnualPrec"))

#ssp585
MeanTemp_585_2021 <- rast(here('VirtualSpecies', 'inputData_forVS', 'FutureEnvData', 'Bio1_585_y21.tif'))
AnnualPrec_585_2021 <- rast(here('VirtualSpecies', 'inputData_forVS', 'FutureEnvData', 'Bio1_585_y21.tif'))
EnvLayers_585_2021 <- c(Elevation, MeanTemp_585_2021, AnnualPrec_585_2021)
names(EnvLayers_585_2021) <- paste0(c("Elevation", "MeanTemp", "AnnualPrec"))
```

Load all the VS if needed:
```{r relaod ISF to reapply to future}
#reload VS
ISF_HD <- formatFunctions(MeanTemp = c(fun = 'dnorm', mean = 23.07, sd = 1.573),
                          AnnualPrec = c(fun = 'dnorm', mean = 2601.74, sd = 347.097),
                          Elevation = c(fun = 'logisticFun', beta = 479, alpha = -70))

ISF_HG <- formatFunctions(MeanTemp = c(fun = 'dnorm', mean = 23.07, sd = 1.573),
                          AnnualPrec = c(fun = 'dnorm', mean = 3341.1, sd = 590.927),
                          Elevation = c(fun = 'logisticFun', beta = 479, alpha = -70))

ISF_HW <- formatFunctions(MeanTemp = c(fun = 'dnorm', mean = 23.07, sd = 1.573),
                          AnnualPrec = c(fun = 'dnorm', mean = 3687.75, sd = 282.767),
                          Elevation = c(fun = 'logisticFun', beta = 479, alpha = -70))

ISF_LD <- formatFunctions(MeanTemp = c(fun = 'dnorm', mean = 26.73, sd = 0.741),
                          AnnualPrec = c(fun = 'dnorm', mean = 2496.18, sd = 314.665),
                          Elevation = c(fun = 'logisticFun', beta = 479, alpha = 70))

ISF_LG <- formatFunctions(MeanTemp = c(fun = 'dnorm', mean = 26.73, sd = 0.741),
                          AnnualPrec = c(fun = 'dnorm', mean = 2955.42, sd = 563.852),
                          Elevation = c(fun = 'logisticFun', beta = 479, alpha = 70))

ISF_LW <- formatFunctions(MeanTemp = c(fun = 'dnorm', mean = 26.73, sd = 0.741),
                          AnnualPrec = c(fun = 'dnorm', mean = 3420.59, sd = 331.15),
                          Elevation = c(fun = 'logisticFun', beta = 479, alpha = 70))
```

# Now all we need is to make the new Habitat suitability, and use that as a resistance raster

we do not need to make new presence points, as this is a purposeful assumption in our study. However, future research should endevour to model how the the movement of these points may effect corridor spatial dynamics. 

explanation of code is only given in the first instance

1) HD:
```{r Genorate Habitat Suitability, HD}
#ssp126
#genorate the habitat suitability from the new climate layers
HSI_HD_fut126_2021 <- generateSpFromFun(raster.stack = EnvLayers_126_2021[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_HD, 
                                      plot = TRUE)

#convert this to a presennce absence map. We do not need this, but it allows us to call 'suitab.raster' within it, which is the the best way to access habitat suitability
HSI_HD_fut126_2021_raster <- convertToPA(HSI_HD_fut126_2021, 
                                         PA.method = "probability", 
                                         prob.method = "linear",
                                         plot = TRUE) 

#and save
writeRaster(HSI_HD_fut126_2021_raster$suitab.raster, 
            "")

#Repeat for all scenarios

#ssp245
HSI_HD_fut245_2021 <- generateSpFromFun(raster.stack = EnvLayers_245_2021[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_HD, 
                                      plot = TRUE)

HSI_HD_fut245_2021_raster <- convertToPA(HSI_HD_fut245_2021, 
                                         PA.method = "probability", 
                                         prob.method = "linear",
                                         plot = TRUE) 

writeRaster(HSI_HD_fut245_2021_raster$suitab.raster, 
            "")

#ssp585
HSI_HD_fut585_2021 <- generateSpFromFun(raster.stack = EnvLayers_585_2021[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_HD, 
                                      plot = TRUE)

HSI_HD_fut585_2021_raster <- convertToPA(HSI_HD_fut585_2021, 
                                         PA.method = "probability", 
                                         prob.method = "linear",
                                         plot = TRUE) 

writeRaster(HSI_HD_fut585_2021_raster$suitab.raster, 
            "")
```

2) HG:
```{r Genorate Habitat Suitability, HG}
#ssp126
HSI_HG_fut126_2021 <- generateSpFromFun(raster.stack = EnvLayers_126_2021[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_HG, 
                                      plot = TRUE)

HSI_HG_fut126_2021_raster <- convertToPA(HSI_HG_fut126_2021, 
                                         PA.method = "probability", 
                                         prob.method = "linear",
                                         plot = TRUE) 

writeRaster(HSI_HG_fut126_2021_raster$suitab.raster, 
            "")

#ssp245
HSI_HG_fut245_2021 <- generateSpFromFun(raster.stack = EnvLayers_245_2021[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_HG, 
                                      plot = TRUE)

HSI_HG_fut245_2021_raster <- convertToPA(HSI_HG_fut245_2021, 
                                         PA.method = "probability", 
                                         prob.method = "linear",
                                         plot = TRUE) 

writeRaster(HSI_HG_fut245_2021_raster$suitab.raster, 
            "")

#ssp585
HSI_HG_fut585_2021 <- generateSpFromFun(raster.stack = EnvLayers_585_2021[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_HG, 
                                      plot = TRUE)

HSI_HG_fut585_2021_raster <- convertToPA(HSI_HG_fut585_2021, 
                                         PA.method = "probability", 
                                         prob.method = "linear",
                                         plot = TRUE) 

writeRaster(HSI_HG_fut585_2021_raster$suitab.raster, 
            "")
```

3) HW:
```{r Genorate Habitat Suitability, HW}
#ssp126
HSI_HW_fut126_2021 <- generateSpFromFun(raster.stack = EnvLayers_126_2021[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_HW, 
                                      plot = TRUE)

HSI_HW_fut126_2021_raster <- convertToPA(HSI_HW_fut126_2021, 
                                         PA.method = "probability", 
                                         prob.method = "linear",
                                         plot = TRUE) 

writeRaster(HSI_HW_fut126_2021_raster$suitab.raster, 
            "")

#ssp245
HSI_HW_fut245_2021 <- generateSpFromFun(raster.stack = EnvLayers_245_2021[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_HW, 
                                      plot = TRUE)

HSI_HW_fut245_2021_raster <- convertToPA(HSI_HW_fut245_2021, 
                                         PA.method = "probability", 
                                         prob.method = "linear",
                                         plot = TRUE) 

writeRaster(HSI_HW_fut245_2021_raster$suitab.raster, 
            "")

#ssp585
HSI_HW_fut585_2021 <- generateSpFromFun(raster.stack = EnvLayers_585_2021[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_HW, 
                                      plot = TRUE)

HSI_HW_fut585_2021_raster <- convertToPA(HSI_HW_fut585_2021, 
                                         PA.method = "probability", 
                                         prob.method = "linear",
                                         plot = TRUE) 

writeRaster(HSI_HW_fut585_2021_raster$suitab.raster, 
            "")
```

4) LD:
```{r Genorate Habitat Suitability, LD}
#ssp126
HSI_LD_fut126_2021 <- generateSpFromFun(raster.stack = EnvLayers_126_2021[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_LD, 
                                      plot = TRUE)

HSI_LD_fut126_2021_raster <- convertToPA(HSI_LD_fut126_2021, 
                                         PA.method = "probability", 
                                         prob.method = "linear",
                                         plot = TRUE) 

writeRaster(HSI_LD_fut126_2021_raster$suitab.raster, 
            "")

#ssp245
HSI_LD_fut245_2021 <- generateSpFromFun(raster.stack = EnvLayers_245_2021[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_LD, 
                                      plot = TRUE)

HSI_LD_fut245_2021_raster <- convertToPA(HSI_LD_fut245_2021, 
                                         PA.method = "probability", 
                                         prob.method = "linear",
                                         plot = TRUE) 

writeRaster(HSI_LD_fut245_2021_raster$suitab.raster, 
            "")

#ssp585
HSI_LD_fut585_2021 <- generateSpFromFun(raster.stack = EnvLayers_585_2021[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_LD, 
                                      plot = TRUE)

HSI_LD_fut585_2021_raster <- convertToPA(HSI_LD_fut585_2021, 
                                         PA.method = "probability", 
                                         prob.method = "linear",
                                         plot = TRUE) 

writeRaster(HSI_LD_fut585_2021_raster$suitab.raster, 
            "")
```

5) LG:
```{r  Genorate Habitat Suitability, LG}
#ssp126
HSI_LG_fut126_2021 <- generateSpFromFun(raster.stack = EnvLayers_126_2021[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_LG, 
                                      plot = TRUE)

HSI_LG_fut126_2021_raster <- convertToPA(HSI_LG_fut126_2021, 
                                         PA.method = "probability", 
                                         prob.method = "linear",
                                         plot = TRUE) 

writeRaster(HSI_LG_fut126_2021_raster$suitab.raster, 
            "")

#ssp245
HSI_LG_fut245_2021 <- generateSpFromFun(raster.stack = EnvLayers_245_2021[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_LG, 
                                      plot = TRUE)

HSI_LG_fut245_2021_raster <- convertToPA(HSI_LG_fut245_2021, 
                                         PA.method = "probability", 
                                         prob.method = "linear",
                                         plot = TRUE) 

writeRaster(HSI_LG_fut245_2021_raster$suitab.raster, 
            "")

#ssp585
HSI_LG_fut585_2021 <- generateSpFromFun(raster.stack = EnvLayers_585_2021[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_LG, 
                                      plot = TRUE)

HSI_LG_fut585_2021_raster <- convertToPA(HSI_LG_fut585_2021, 
                                         PA.method = "probability", 
                                         prob.method = "linear",
                                         plot = TRUE) 

writeRaster(HSI_LG_fut585_2021_raster$suitab.raster, 
            "")
```

6) LW:
```{r  Genorate Habitat Suitability, LW}
#ssp126
HSI_LW_fut126_2021 <- generateSpFromFun(raster.stack = EnvLayers_126_2021[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_LW, 
                                      plot = TRUE)

HSI_LW_fut126_2021_raster <- convertToPA(HSI_LW_fut126_2021, 
                                         PA.method = "probability", 
                                         prob.method = "linear",
                                         plot = TRUE) 

writeRaster(HSI_LW_fut126_2021_raster$suitab.raster, 
            "")

#ssp245
HSI_LW_fut245_2021 <- generateSpFromFun(raster.stack = EnvLayers_245_2021[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_LW, 
                                      plot = TRUE)

HSI_LW_fut245_2021_raster <- convertToPA(HSI_LW_fut245_2021, 
                                         PA.method = "probability", 
                                         prob.method = "linear",
                                         plot = TRUE) 

writeRaster(HSI_LW_fut245_2021_raster$suitab.raster, 
            "")

#ssp585
HSI_LW_fut585_2021 <- generateSpFromFun(raster.stack = EnvLayers_585_2021[[c("MeanTemp", "AnnualPrec", "Elevation")]], 
                                      parameters = ISF_LW, 
                                      plot = TRUE)

HSI_LW_fut585_2021_raster <- convertToPA(HSI_LW_fut585_2021, 
                                         PA.method = "probability", 
                                         prob.method = "linear",
                                         plot = TRUE) 

writeRaster(HSI_LW_fut585_2021_raster$suitab.raster, 
            "")
```

These can be converted into resistance in R, but I reccomend doing so using the native tools in arcgis for conversion. This is because you will have to resample the rasters anyway and ensure they conform in extent, crs, projection, and pixel dimensions. 

Once done so, you can make a 'ConnectivityAlgorithm_inputs' folder. It needs the resitance raster in .asci, and the Presence only points (usually in .XY, or .csv), but may vary depending on the software. 

### Conclusion

Upon doing so, you can now compile inputs for both baseline and future scenarios, allowing you to genorate the baseline and comparison corridor networks. I have supplied my ColA input folders in the 'ConnectivityAlgorithm_inputs' folder in VirtualSpecies. This is the output of this workpackage.

For use of CoLa, please see their available guides. 




